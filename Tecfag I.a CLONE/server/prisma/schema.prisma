generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                @id @default(uuid())
  email                  String                @unique
  password               String
  name                   String
  role                   String                @default("USER")
  lastActive             DateTime              @default(now())
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  mustChangePassword     Boolean               @default(false)
  jobTitle               String?
  department             String?
  technicalLevel         String?
  communicationStyle     String?
  accessGroupId          String?
  canViewChat            Boolean?
  canViewMindMap         Boolean?
  canViewCatalog         Boolean?
  canViewUsers           Boolean?
  canViewMonitoring      Boolean?
  canViewDocuments       Boolean?
  canViewSettings        Boolean?
  canViewNotifications   Boolean?
  canCreateMindMap       Boolean?
  canEditMindMap         Boolean?
  canDeleteMindMap       Boolean?
  canCreateCatalog       Boolean?
  canEditCatalog         Boolean?
  canDeleteCatalog       Boolean?
  canCreateUsers         Boolean?
  canEditUsers           Boolean?
  canDeleteUsers         Boolean?
  canUploadDocuments     Boolean?
  canEditDocuments       Boolean?
  canDeleteDocuments     Boolean?
  canArchiveChat         Boolean?
  canDeleteChatHistory   Boolean?
  canDeleteNotifications Boolean?
  canManageAccessGroups  Boolean?
  canManageBackups       Boolean?
  canViewTokenCosts      Boolean?
  archivedChats          ArchivedChat[]
  chatFolders            ChatFolder[]
  chatMessages           ChatMessage[]
  chatSessionContext     ChatSessionContext?
  messageFeedbacks       MessageFeedback[]
  notifications          Notification[]
  notificationSettings   NotificationSettings?
  tokenUsages            TokenUsage[]
  accessGroup            AccessGroup?          @relation(fields: [accessGroupId], references: [id])
}

model AccessGroup {
  id                     String   @id @default(uuid())
  name                   String   @unique
  description            String?
  canViewChat            Boolean  @default(true)
  canViewMindMap         Boolean  @default(true)
  canViewCatalog         Boolean  @default(true)
  canViewUsers           Boolean  @default(false)
  canViewMonitoring      Boolean  @default(false)
  canViewDocuments       Boolean  @default(false)
  canViewSettings        Boolean  @default(false)
  canViewNotifications   Boolean  @default(true)
  canCreateMindMap       Boolean  @default(true)
  canEditMindMap         Boolean  @default(true)
  canDeleteMindMap       Boolean  @default(false)
  canCreateCatalog       Boolean  @default(false)
  canEditCatalog         Boolean  @default(false)
  canDeleteCatalog       Boolean  @default(false)
  canCreateUsers         Boolean  @default(false)
  canEditUsers           Boolean  @default(false)
  canDeleteUsers         Boolean  @default(false)
  canUploadDocuments     Boolean  @default(false)
  canEditDocuments       Boolean  @default(false)
  canDeleteDocuments     Boolean  @default(false)
  canArchiveChat         Boolean  @default(true)
  canDeleteChatHistory   Boolean  @default(true)
  canDeleteNotifications Boolean  @default(true)
  canManageAccessGroups  Boolean  @default(false)
  canManageBackups       Boolean  @default(false)
  canViewTokenCosts      Boolean  @default(false)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  users                  User[]
}

model MessageFeedback {
  id             String   @id @default(uuid())
  messageId      String?
  messageContent String
  queryContent   String
  rating         String
  category       String?
  comment        String?
  userId         String
  model          String?
  catalogId      String?
  createdAt      DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([rating])
  @@index([category])
  @@index([userId])
  @@index([createdAt])
}

model ChatSessionContext {
  id                  String   @id @default(uuid())
  userId              String   @unique
  contextSummary      String?
  mentionedEntities   String?
  providedInfo        String?
  detectedPreferences String?
  messageCount        Int      @default(0)
  lastUpdated         DateTime @default(now())
  createdAt           DateTime @default(now())
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model TokenUsage {
  id           String   @id @default(uuid())
  userId       String
  inputTokens  Int
  outputTokens Int
  totalTokens  Int
  model        String
  requestType  String   @default("chat")
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model TokenCostSettings {
  id              String   @id @default(uuid())
  inputCostPer1M  Float    @default(0)
  outputCostPer1M Float    @default(0)
  currency        String   @default("BRL")
  updatedAt       DateTime @updatedAt
}

model Machine {
  id                String                 @id @default(uuid())
  name              String
  category          String
  capacity          String
  model             String
  price             String
  maintenanceStatus String                 @default("ok")
  lastMaintenance   String
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  specifications    MachineSpecification[]
}

model MachineSpecification {
  id        String  @id @default(uuid())
  machineId String
  content   String
  machine   Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)
}

model MindMap {
  id        String        @id @default(uuid())
  name      String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  nodes     MindMapNode[]
}

model MindMapNode {
  id              String              @id @default(uuid())
  mindMapId       String
  label           String
  type            String
  x               Float
  y               Float
  connectionsFrom MindMapConnection[] @relation("FromNode")
  connectionsTo   MindMapConnection[] @relation("ToNode")
  mindMap         MindMap             @relation(fields: [mindMapId], references: [id], onDelete: Cascade)
}

model MindMapConnection {
  id         String      @id @default(uuid())
  fromNodeId String
  toNodeId   String
  fromNode   MindMapNode @relation("FromNode", fields: [fromNodeId], references: [id], onDelete: Cascade)
  toNode     MindMapNode @relation("ToNode", fields: [toNodeId], references: [id], onDelete: Cascade)

  @@unique([fromNodeId, toNodeId])
}

model ChatMessage {
  id        String   @id @default(uuid())
  userId    String
  role      String
  content   String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ArchivedChat {
  id            String      @id @default(uuid())
  userId        String
  title         String
  messagesCount Int
  messages      String
  createdAt     DateTime    @default(now())
  archivedAt    DateTime    @default(now())
  folderId      String?
  isPinned      Boolean     @default(false)
  folder        ChatFolder? @relation(fields: [folderId], references: [id])
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ChatFolder {
  id            String         @id @default(uuid())
  userId        String
  name          String
  isDefault     Boolean        @default(false)
  order         Int            @default(0)
  createdAt     DateTime       @default(now())
  archivedChats ArchivedChat[]
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CatalogItem {
  id          String     @id @default(uuid())
  code        String     @unique
  name        String
  category    String
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  documents   Document[]
}

model DocumentFolder {
  id        String           @id @default(uuid())
  name      String
  order     Int              @default(0)
  createdAt DateTime         @default(now())
  parentId  String?
  documents Document[]
  parent    DocumentFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id])
  children  DocumentFolder[] @relation("FolderHierarchy")
}

model Document {
  id                 String          @id @default(uuid())
  catalogId          String?
  deliveryMode       String          @default("text")
  folderId           String?
  fileName           String
  fileType           String
  fileSize           Int
  filePath           String
  indexed            Boolean         @default(false)
  processingProgress Int             @default(0)
  processingError    String?
  isActive           Boolean         @default(true)
  chunkCount         Int?
  totalTokens        Int?
  uploadedBy         String?
  uploadedAt         DateTime        @default(now())
  indexedAt          DateTime?
  version            Int             @default(1)
  previousVersionId  String?
  catalogItem        CatalogItem?    @relation(fields: [catalogId], references: [id])
  folder             DocumentFolder? @relation(fields: [folderId], references: [id])
  chunks             DocumentChunk[]
}

model DocumentChunk {
  id         String   @id @default(uuid())
  documentId String
  content    String
  chunkIndex Int
  embedding  String
  metadata   String?
  createdAt  DateTime @default(now())
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
}

model QueryCache {
  id             String   @id @default(uuid())
  queryText      String
  queryHash      String   @unique
  queryEmbedding String
  response       String
  sources        String?
  hitCount       Int      @default(0)
  catalogId      String?
  userId         String?
  documentIds    String
  createdAt      DateTime @default(now())
  lastUsed       DateTime @default(now())
  expiresAt      DateTime

  @@index([queryHash])
  @@index([catalogId])
  @@index([userId])
  @@index([expiresAt])
}

model EmbeddingCache {
  id        String   @id @default(uuid())
  textHash  String   @unique
  embedding String
  createdAt DateTime @default(now())

  @@index([textHash])
}

model NotificationSettings {
  id                String   @id @default(uuid())
  userId            String   @unique
  systemAlerts      Boolean  @default(true)
  userAlerts        Boolean  @default(true)
  documentAlerts    Boolean  @default(true)
  chatAlerts        Boolean  @default(true)
  inAppEnabled      Boolean  @default(true)
  emailEnabled      Boolean  @default(false)
  frequency         String   @default("realtime")
  quietHoursEnabled Boolean  @default(false)
  quietHoursStart   String?
  quietHoursEnd     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Notification {
  id        String    @id @default(uuid())
  userId    String
  type      String
  category  String
  title     String
  message   String
  metadata  String?
  isRead    Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
}
